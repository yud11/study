
# 背景介绍
## 简介
> 公司核心产品 alpha-engine 是一款收集指标数据以图表或表格等各种形式展现，给金融从业人员做数据参考的智能数据整合平台，这次需要调优的对象是最为关键的指标中心的指标综合搜索功能，随着业务的增长，指标中心的整体数量由 20w 数量级上涨至 1500w，横跨两个数量级同时带来的是指标综合搜索功能由原来的平均 `1.5` 响应一次变为 `16s` 响应一次

## 已知条件
* 单个指标数据为 100k 左右，整个 es 上存储的数据大小在  1.5T 左右
* 整个 es 集群为 3 个节点，每个节点 8g 内存，2T 的磁盘空间
* 指标索引数量为 8个，分别对应指标的 8 个分类，搜索时以 ==indicator_== 做前缀匹配搜索，索引默认分片 3 个
# 优化步骤
==问题==：
首先从 ES 服务器来考虑优化点，默认分片 3 个比较小
==处理方式==：
没有充分利用到 ES 的多线程检索能力，后面调整为 10 个

==问题==：
由于业务原因，指标搜索的时候根据指标名称来搜使用的是 ES 的 wildcard 匹配搜索，同时系统开发了二次筛选的功能，每次检索指标会根据指标的维度、度量、频率等属性进行聚合，这个功能和搜索接口强耦合，比较浪费性能，又因为聚合二次筛选条件会通过 db 进行数组装，一旦返回的维度属性比较多的时候，db 面临很大的查询压力，也会导致接口响应慢
==处理方式==：
1、首先和产品沟通，在功能上做妥协，使用 Es 的 matchQuery，进行分词搜索，同时创建自定义字典，满足公司业务需求上一些特殊词的检索
2、使用 ES 的聚合功能，让数据组同事在ES的指标数据中冗余一份维度、度量、频率等信息，利用 ES 的聚合功能聚合前 10000 条数据的维度等信息（更多的聚合数据需要用户更精确的搜索条件来减少聚合的标本数据），然后将聚合功能从搜索接口中抽离出来，只有使用二次筛选的时候才会去调用聚合接口，减少搜索接口的负担
3、取消索引的前缀搜索，搜索接口接收前端传入的指标类型参数，选择对应的索引进行搜索，减少检索数据范围

==问题==：
指标搜索有一个相关纪要文档的正文搜索功能，经过日志分析，这种条件下的搜索非常耗时
==处理方式==：
空间换时间-> 纪要文档的正文非常长，和产品讨论后，利用公司 AI 组的提取摘要功能，将正文内容分析成摘要，单独洗入一个用于检索的字段，修改查询条件，不对正文进行检索，对摘要进行检索
# 优化结果
指标数据检索速度由原来的 12s 一次优化至 200ms 一次
