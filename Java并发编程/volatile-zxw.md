## volatile 关键字详解

### 简介

volatile是Java中的一个关键字，其提供了一种轻量级的同步机制，保证了在多线程环境下，共享数据的可见性，同时在对被volatile修饰的变量进行操作时禁止指令重排序，但其并不能保证原子性。

### 为什么需要volatile关键字

#### 物理机内存模型

由于计算机存储设备与处理器的运算速度有几个数量级差距，现代计算机都不得不加一层读写尽可能接近处理器运算速度的高速缓存(Cache)作为内存与cpu之间的缓存，将运算需要的数据复制到缓存，让运算快速进行；当运算结束后再从缓存同步会内存，这样处理器就无需等待缓慢的内存读写了。但这引起了新的问题:缓存一致性(Cache Coherence)。即多处理器系统，每个处理器都有自己的高速缓存，但又共享同一主内存(Mian Memory),当运算都涉及同一块主内存，那么将谁的数据同步到主内存，以谁的为准呢？为解决一致性问题，物理机处理器都遵循一些协议来解决一致性。

除了高速缓存，为了是处理器内部运算单元尽可能被充分利用，处理器可能对输入的代码乱序执行(Out-Of-Order Execution)优化。与处理器乱序执行优化类似，JVM即时编译也有类似的指令重排序(Instruction Reorder)，内存模型如下图:

![](H:\笔记\学习笔记\images\volatile-1.webp.jpg)

#### java内存模型

![](H:\笔记\学习笔记\images\volatile-2.webp.jpg)

简单来说:引入volatile关键字是为了保证主内存的变量对于不同线程是立即可见的，这样解决了可见性问题，但无法解决高并发。下面说一下volatile是什么？ 

### volatile作用

#### 保证可见性、禁止指令重排序

 当一个变量被定义为volatile时，它将具备两个特性。第一是保证此变量对所有线程的可见性，即一个线程修改变量值，新值对其他线程立即可见；第二是禁止指令重排序优化，而普通变量不能做到这一点。 怎样实现的呢？

在对被volatile修饰的变量进行写操作时，产生汇编代码之后，在该位置会有一个lock前置指令，也相当于内存屏障，该屏障提供三个功能：

1：将当前处理器缓存行的数据写回系统内存；

2：让其他CPU里缓存了该内存地址的数据无效；

3：确保指令重排序时，不会将屏障前的操作排到屏障后，也不会将后边的操作排到屏障前。

第一点保证了当前处理器缓存行、主内存中数据为最新数据，但仍然不能保证其他处理器缓存行的数据为最新数据，因此为了在多线程情况下，保证其他处理器缓存行中数据一致，每个处理器通过嗅探在总线上传播的数据来检查自己缓存的值是不是过期了，当处理器发现自己缓存行对应的内存地址被修改，就会将当前处理器的缓存行中数据设置成无效状态，当处理器对这个数据进行修改操作的时候，会重新从主内存中把数据读到处理器缓存行中。这样就保证了各个处理器中数据一致了。

#### 不保证原子性

原子性：在Java中，对基本数据类型的变量的读取和赋值操作是原子性操作，即这些操作是不可被中断的，要么执行，要么不执行。 

volatile并不能保证原子性，代码示例：

```java
class ShareData {
    public volatile int i;
    void addOne() {
            i ++;
    }
}

public class VolatileLearning {
    public static void main(String[] args) {
        ShareData sd = new ShareData();
        for (int i = 0; i < 10; i++) {
            new Thread(() -> {
                for (int j = 0; j < 1000; j++) {
                    sd.addOne();
                }
            }).start();
        }

        while(Thread.activeCount() > 1) {
            Thread.yield();
        }
        System.out.println("i的值变为" + sd.i);
    }
}

```

这段程序的输出结果并不是10000，而且每次执行的结果都不一样。这段程序是volatile不能保证原子性的一个现象，但具体原理不太明白。贴一份博客，对于不保证原子性的解释没看明白

 https://www.cnblogs.com/dolphin0520/p/3920373.html 

